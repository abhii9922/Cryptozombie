<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>CryptoZombies</title>
  <link rel="icon" href="favicon.ico">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/web3/1.2.7-rc.0/web3.min.js"></script>
  <script src="cryptozombies_abi.js"></script>
  <link href="./dist/styles.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.0.3/dist/tailwind.min.css" rel="stylesheet">
</head>

<body class="bg-gray-900 text-white">
  <div class="container mx-auto px-4 py-4">
    <div id="txStatus" class="p-4 mb-4 text-lg"></div>

    <!-- Button Container -->
    <div class="flex justify-center gap-4 mb-8">
      <button
        class="showZombieButton bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline">Show
        Zombies</button>
      <button
        class="createzombieButton bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline">Create
        Zombie</button>
      <button
        class="levelupButton bg-red-500 hover:bg-red-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline">Level
        Up</button>
    </div>

    <!-- Zombie Cards Container -->
    <div id="zombies" class="grid grid-cols-1 md:grid-cols-3 gap-4">
      <!-- Zombie cards will be dynamically inserted here by JavaScript -->
    </div>

  </div>


  <script>

    var cryptoZombies;
    var userAccount;
    const showZombieButton = document.querySelector('.showZombieButton');
    const createzombieButton = document.querySelector('.createzombieButton');
    const levelupButton = document.querySelector('.levelupButton');

    function startApp() {
	
      //ZombieOwnership contratc address
      var cryptoZombiesAddress = "0xb643793d481C41f9fD3dEd6E6B67b958C88B42e8";

      cryptoZombies = new web3.eth.Contract(cryptoZombiesABI, cryptoZombiesAddress);

      cryptoZombies.events.Transfer({ filter: { _to: userAccount } })
        .on("data", function (event) {
          let data = event.returnValues;
          getZombiesByOwner(userAccount).then(displayZombies);
        }).on("error", console.error);
    }

    function displayZombies(ids) {
        $("#zombies").empty();
        for (let id of ids) {
          getZombieDetails(id)
            .then(function (zombie) {
              const zombieImageUrl = getImageForZombieLevel(zombie.level);
              const zombieCardHtml = `
        <div class="zombie bg-gray-800 rounded-lg shadow-xl overflow-hidden flex flex-col md:flex-row m-4">
          <img src="${zombieImageUrl}" alt="Zombie Image" class="w-full md:w-1/3 object-cover">
          <div class="flex-1 text-left p-4">
            <h3 class="text-xl text-green-400 mb-2">${zombie.name}</h3>
            <p class="text-sm text-gray-400">DNA: ${zombie.dna}</p>
            <p class="text-sm text-gray-400">Level: ${zombie.level}</p>
            <div class="text-sm text-gray-400 mb-2">Wins: ${zombie.winCount} / Losses: ${zombie.lossCount}</div>
            <p class="text-sm text-gray-400">Ready Time: ${new Date(zombie.readyTime * 1000).toLocaleString()}</p>
            <div class="mt-4">
              <button onclick="levelUp(${id})" class="level-up-btn text-white bg-green-500 hover:bg-green-600 rounded px-4 py-2 transition duration-300 ease-in-out">
                Level Up
              </button>
            </div>
          </div>
        </div>
        `;
              $("#zombies").append(zombieCardHtml);
            });
        }
      }

      
      function getImageForZombieLevel(level) {
          const basePath = 'image'; // Replace with your actual path to images directory
          // Make sure the level is an integer
          level = parseInt(level, 10);

          // Define an image for each level
          let imageName = `level_${level}.png`;

          // Check if the level is within 1 to 8, otherwise use a max level image
          if (level < 1 || level > 8) {
            imageName = 'level_8.png';
          }

          return `${basePath}/${imageName}`;
        }


    function createRandomZombie(name) {


      $("#txStatus").text("Creating new zombie on the blockchain. This may take a while...");

      return cryptoZombies.methods.createRandomZombie(name)
        .send({ from: userAccount })
        .on("receipt", function (receipt) {
          $("#txStatus").text("Successfully created " + name + "!");

          getZombiesByOwner(userAccount).then(displayZombies);
          
        })
        .on("error", function (error) {

          $("#txStatus").text(error);
        });
    }

    function feedOnKitty(zombieId, kittyId) {
      $("#txStatus").text("Eating a kitty. This may take a while...");
      return cryptoZombies.methods.feedOnKitty(zombieId, kittyId)
        .send({ from: userAccount })
        .on("receipt", function (receipt) {
          $("#txStatus").text("Ate a kitty and spawned a new Zombie!");
          getZombiesByOwner(userAccount).then(displayZombies);
        })
        .on("error", function (error) {
          $("#txStatus").text(error);
        });
    }

    function levelUp(zombieId) {
      $("#txStatus").text("Leveling up your zombie...");
      return cryptoZombies.methods.levelUp(zombieId)
        .send({ from: userAccount, value: web3.utils.toWei("0.001", "ether") })
        .on("receipt", function (receipt) {
          $("#txStatus").text("Power overwhelming! Zombie successfully leveled up");
        })
        .on("error", function (error) {
          $("#txStatus").text(error);
        });
    }

    function getZombieDetails(id) {
      return cryptoZombies.methods.zombies(id).call()
    }

    function zombieToOwner(id) {
      return cryptoZombies.methods.zombieToOwner(id).call()
    }

    function getZombiesByOwner(owner) {
      return cryptoZombies.methods.getZombiesByOwner(owner).call()
    }

    window.addEventListener('load', async () => {
    // Modern dapp browsers...
    if (window.ethereum) {
        window.web3 = new Web3(ethereum);
        try {
            // Request account access if needed
            const accounts = await ethereum.enable();
            // Acccounts now exposed
            userAccount = accounts[0];
            startApp()
        } catch (error) {
            // User denied account access...
        }
    }
    // Legacy dapp browsers...
    else if (window.web3) {
        window.web3 = new Web3(web3.currentProvider);
        // Acccounts always exposed
        userAccount = web3.eth.accounts[0];
        startApp()
    }
    // Non-dapp browsers...
    else {
        console.log('Non-Ethereum browser detected. You should consider trying MetaMask!');
    }
   });
 
    window.addEventListener('load', async () => {
      // Modern dapp browsers...
      if (window.ethereum) {
          window.web3 = new Web3(ethereum);
          try {
              // Request account access if needed
              const accounts = await ethereum.enable();
              // Acccounts now exposed
              userAccount = accounts[0];
              METokencontract = new web3.eth.Contract(METFABI, METokenFAddress);
          } catch (error) {
              // User denied account access...
          }
      } 
    })

   ethereum.on('accountsChanged', (accounts) => {
       window.location.reload();
   });

   ethereum.on('chainChanged', (chainId) => {
       window.location.reload(); 
   });  

 
    createzombieButton.addEventListener('click', () => {
      createRandomZombie(userAccount);

    });

    showZombieButton.addEventListener('click', () => {
      getZombiesByOwner(userAccount)
            .then(displayZombies);

    });

    levelupButton.addEventListener('click', () => {
      getZombiesByOwner(userAccount)
            .then(levelUp);

    });



  </script>
</body>

</html>